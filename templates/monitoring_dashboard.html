{% extends "base.html" %}

{% block title %}News Analysis System Monitoring{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block extra_styles %}
    <style>
        .metric-card {
            transition: var(--transition-default);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        .health-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .health-healthy { background-color: var(--color-accent-green); }
        .health-warning { background-color: var(--color-accent-warning); }
        .health-error { background-color: var(--color-accent-red); }

        .anomaly-item {
            border-left: 4px solid var(--color-accent-red);
            background: #f8d7da;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0 var(--radius-button) var(--radius-button) 0;
        }

        .anomaly-medium { border-left-color: var(--color-accent-warning); background: #fff3cd; }
        .anomaly-low { border-left-color: var(--color-accent-blue); background: #d1ecf1; }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center py-3">
                    <h2 class="ds-page-title d-flex align-items-center gap-2 mb-0">
                        <i data-lucide="bar-chart-3" style="width: 28px; height: 28px;" class="text-primary"></i>
                        System Monitoring
                    </h2>
                    <div class="d-flex align-items-center gap-3">
                        <div>
                            <span class="health-indicator health-{{ data.health_status }}"></span>
                            <span class="ds-muted">Status:
                                {% if data.health_status == 'healthy' %}
                                    <span class="text-success">Healthy</span>
                                {% elif data.health_status == 'issues_detected' %}
                                    <span class="text-warning">Issues Detected</span>
                                {% else %}
                                    <span class="text-danger">Error</span>
                                {% endif %}
                            </span>
                        </div>
                        <a href="/news" class="ds-btn-secondary d-inline-flex align-items-center gap-2">
                            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
                            Back to Analysis
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Metrics -->
        <div class="row">
            <div class="col-md-3">
                <div class="ds-kpi-card metric-card ds-card-accent-purple text-center">
                    <h3 class="mb-1 ds-tabular-nums">{{ data.real_time_metrics.recent_requests_count or 0 }}</h3>
                    <small class="d-block mb-2">Recent Requests</small>
                    <div class="mt-2 ds-muted d-flex align-items-center justify-content-center gap-2">
                        <i data-lucide="clock" style="width: 14px; height: 14px;"></i>
                        <span>Last {{ data.real_time_metrics.recent_requests_count or 0 }} analyses</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="ds-kpi-card metric-card ds-card-accent-blue text-center">
                    <h3 class="mb-1 ds-tabular-nums">{{ data.real_time_metrics.avg_articles or 0 }}</h3>
                    <small class="d-block mb-2">Avg Articles per Analysis</small>
                    <div class="mt-2 ds-muted d-flex align-items-center justify-content-center gap-2">
                        <i data-lucide="newspaper" style="width: 14px; height: 14px;"></i>
                        <span>Article quality</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="ds-kpi-card metric-card ds-card-accent-green text-center">
                    <h3 class="mb-1 ds-tabular-nums">{{ data.real_time_metrics.avg_response_time or 0 }}s</h3>
                    <small class="d-block mb-2">Avg Response Time</small>
                    <div class="mt-2 ds-muted d-flex align-items-center justify-content-center gap-2">
                        <i data-lucide="gauge" style="width: 14px; height: 14px;"></i>
                        <span>Performance</span>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="ds-kpi-card metric-card ds-card-accent-red text-center">
                    <h3 class="mb-1 ds-tabular-nums">{{ data.anomalies|length }}</h3>
                    <small class="d-block mb-2">Active Issues</small>
                    <div class="mt-2 ds-muted d-flex align-items-center justify-content-center gap-2">
                        <i data-lucide="alert-triangle" style="width: 14px; height: 14px;"></i>
                        <span>{% if data.anomalies|length == 0 %}All Good{% else %}Needs Attention{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <!-- Source Performance Chart -->
            <div class="col-md-6">
                <div class="ds-card mb-4">
                    <h5 class="ds-section-title mb-3 d-flex align-items-center gap-2">
                        <i data-lucide="database" style="width: 18px; height: 18px;"></i>
                        Source Performance (7 Days)
                    </h5>
                    <canvas id="sourcePerformanceChart" height="300"></canvas>
                </div>
            </div>

            <!-- Quality Trends Chart -->
            <div class="col-md-6">
                <div class="ds-card mb-4">
                    <h5 class="ds-section-title mb-3 d-flex align-items-center gap-2">
                        <i data-lucide="star" style="width: 18px; height: 18px;"></i>
                        Analysis Quality Distribution
                    </h5>
                    <canvas id="qualityDistributionChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Detailed Metrics -->
        <div class="row">
            <!-- Weekly Summary -->
            <div class="col-md-4">
                <div class="ds-card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="calendar" style="width: 16px; height: 16px;"></i>
                            Weekly Summary
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if data.weekly_summary %}
                        <ul class="list-unstyled mb-0">
                            <li><strong>Total Analyses:</strong> {{ data.weekly_summary.total_analyses or 0 }}</li>
                            <li><strong>Avg Articles:</strong> {{ data.weekly_summary.avg_articles_per_analysis or 0 }}</li>
                            <li><strong>Premium Coverage:</strong> {{ data.weekly_summary.avg_premium_percentage or 0 }}%</li>
                            <li><strong>Avg Response Time:</strong> {{ data.weekly_summary.avg_response_time_seconds or 0 }}s</li>
                        </ul>
                        {% else %}
                        <p class="text-muted">No weekly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- API Performance -->
            <div class="col-md-4">
                <div class="ds-card">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="plug" style="width: 16px; height: 16px;"></i>
                            API Performance
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if data.weekly_summary and data.weekly_summary.api_performance %}
                        {% for api, metrics in data.weekly_summary.api_performance.items() %}
                        <div class="mb-2">
                            <div class="d-flex justify-content-between">
                                <span><strong>{{ api.title() }}:</strong></span>
                                <span class="{% if metrics.success_rate >= 90 %}text-success{% elif metrics.success_rate >= 70 %}text-warning{% else %}text-danger{% endif %}">
                                    {{ metrics.success_rate|round(1) }}%
                                </span>
                            </div>
                            <small class="text-muted">{{ metrics.total_calls }} calls, {{ metrics.avg_response_time_ms|round }}ms avg</small>
                        </div>
                        {% endfor %}
                        {% else %}
                        <p class="text-muted">No API performance data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- System Health -->
            <div class="col-md-4">
                <div class="ds-card">
                    <div class="card-header {% if data.anomalies|length == 0 %}bg-success{% else %}bg-warning{% endif %} text-white">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="heart-pulse" style="width: 16px; height: 16px;"></i>
                            System Health
                        </h6>
                    </div>
                    <div class="card-body">
                        {% if data.anomalies %}
                        {% for anomaly in data.anomalies %}
                        <div class="anomaly-item anomaly-{{ anomaly.severity }}">
                            <strong>{{ anomaly.type.replace('_', ' ').title() }}</strong>
                            <p class="mb-1 small">{{ anomaly.message }}</p>
                            <small class="text-muted">{{ anomaly.recommendation }}</small>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="text-success">
                            <i class="fas fa-check-circle"></i> All systems operating normally
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Export and Actions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="ds-card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                            Export & Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" role="group">
                            <a href="/api/monitoring/export?days=7" class="ds-btn-secondary d-inline-flex align-items-center gap-2">
                                <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                                Export 7 Days
                            </a>
                            <a href="/api/monitoring/export?days=30" class="ds-btn-secondary d-inline-flex align-items-center gap-2">
                                <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                                Export 30 Days
                            </a>
                            <button onclick="refreshDashboard()" class="ds-btn-secondary d-inline-flex align-items-center gap-2">
                                <i data-lucide="refresh-cw" style="width: 14px; height: 14px;"></i>
                                Refresh
                            </button>
                            <button onclick="checkAnomalies()" class="ds-btn-secondary d-inline-flex align-items-center gap-2">
                                <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                                Check Issues
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        // Source Performance Chart
        const sourceCtx = document.getElementById('sourcePerformanceChart').getContext('2d');
        const sourceData = {{ data.real_time_metrics.source_totals|tojson if data.real_time_metrics.source_totals else '{}' }};
        
        new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(sourceData),
                datasets: [{
                    data: Object.values(sourceData),
                    backgroundColor: [
                        '#6f42c1', // AlphaVantage - Purple
                        '#fd7e14', // NYT - Orange  
                        '#20c997', // RSS - Teal
                        '#dc3545'  // Google - Red
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // Quality Distribution Chart
        const qualityCtx = document.getElementById('qualityDistributionChart').getContext('2d');
        const qualityData = {{ data.real_time_metrics.quality_distribution|tojson if data.real_time_metrics.quality_distribution else '{}' }};
        
        new Chart(qualityCtx, {
            type: 'bar',
            data: {
                labels: Object.keys(qualityData),
                datasets: [{
                    label: 'Analyses',
                    data: Object.values(qualityData),
                    backgroundColor: [
                        '#28a745', // Premium+ - Green
                        '#007bff', // Institutional - Blue
                        '#17a2b8', // Professional - Cyan
                        '#ffc107', // Standard - Yellow
                        '#6c757d'  // Limited - Gray
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Dashboard functions
        function refreshDashboard() {
            window.location.reload();
        }

        function checkAnomalies() {
            fetch('/api/monitoring/anomalies')
                .then(response => response.json())
                .then(data => {
                    if (data.count === 0) {
                        alert('✅ No anomalies detected. System is running normally.');
                    } else {
                        alert(`⚠️ Found ${data.count} issues. Check the System Health panel for details.`);
                    }
                })
                .catch(error => {
                    alert('❌ Error checking anomalies: ' + error.message);
                });
        }

        // Auto-refresh every 5 minutes
        setInterval(function() {
            console.log('Auto-refreshing dashboard...');
            window.location.reload();
        }, 5 * 60 * 1000);

        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
{% endblock %}