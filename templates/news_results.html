<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ company }} - Premium Financial Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .analysis-section {
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            margin-bottom: 1.5rem;
        }
        .executive-section { border-left-color: #28a745; }
        .investor-section { border-left-color: #007bff; }
        .catalysts-section { border-left-color: #dc3545; }
        
        .quality-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .source-link {
            color: #6c757d;
            text-decoration: none;
            font-size: 0.85rem;
        }
        
        .source-link:hover {
            color: #007bff;
            text-decoration: underline;
        }
        
        .article-item {
            border-bottom: 1px solid #dee2e6;
            padding: 0.75rem 0;
        }
        
        .article-item:last-child {
            border-bottom: none;
        }
        
        .premium-source {
            color: #28a745;
            font-weight: 600;
        }
        
        .alphavantage-source {
            color: #6f42c1;
            font-weight: 600;
        }
        
        .nyt-source {
            color: #fd7e14;
            font-weight: 600;
        }
        
        .rss-source {
            color: #20c997;
            font-weight: 600;
        }
        
        .standard-source {
            color: #6c757d;
        }
        
        .insight-bullet {
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .source-breakdown {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
        }
        
        .progress-thin {
            height: 6px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            backdrop-filter: blur(10px);
            color: #333 !important; /* ✅ Fix: Ensure text is dark */
        }

        .metric-card small,
        .metric-card .small {
            color: #6c757d !important; /* ✅ Fix: Ensure small text is visible gray */
        }
        
        @media (max-width: 768px) {
            .back-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Back Button -->
        <a href="/news" class="btn btn-outline-secondary back-button">
            <i class="fas fa-arrow-left"></i> New Analysis
        </a>
        
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <!-- Enhanced Header with Premium Metrics -->
                <div class="text-center mb-4 mt-4">
                    <h2 class="mb-2">
                        <i class="fas fa-chart-line text-primary"></i>
                        Premium Financial Analysis: {{ company }}
                    </h2>
                    <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                        <span class="badge bg-secondary">{{ date_range }}</span>
                        <span class="badge quality-badge 
                            {% if analysis_quality == 'Premium+' %}bg-success
                            {% elif analysis_quality == 'Institutional' %}bg-primary
                            {% elif analysis_quality == 'Professional' %}bg-info
                            {% elif analysis_quality == 'Standard' %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {{ analysis_quality }} Grade
                        </span>
                        <span class="text-muted">
                            <i class="fas fa-newspaper"></i> {{ article_count }} articles
                        </span>
                    </div>
                    
                    <!-- Enhanced Analysis Quality Description -->
                    {% if analysis_quality == 'Premium+' %}
                    <small class="text-success d-block mt-2">
                        <i class="fas fa-crown"></i> Premium+ analysis with AlphaVantage sentiment data + NYT full abstracts + premium RSS feeds
                    </small>
                    {% elif analysis_quality == 'Institutional' %}
                    <small class="text-primary d-block mt-2">
                        <i class="fas fa-university"></i> Institutional-grade analysis with quantified impacts and multiple premium sources
                    </small>
                    {% elif analysis_quality == 'Professional' %}
                    <small class="text-info d-block mt-2">
                        <i class="fas fa-briefcase"></i> Professional-grade analysis with enhanced content and business context
                    </small>
                    {% elif analysis_quality == 'Standard' %}
                    <small class="text-warning d-block mt-2">
                        <i class="fas fa-info-circle"></i> Standard analysis with premium source coverage
                    </small>
                    {% else %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-exclamation-triangle"></i> Limited sources - comprehensive analysis of available data
                    </small>
                    {% endif %}
                </div>

                <!-- Quality Validation Display -->
                {% if quality_validation and quality_validation.enabled %}
                <div class="alert {% if quality_validation.passed %}alert-success{% elif quality_validation.passed == False %}alert-warning{% else %}alert-info{% endif %} mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">
                                <i class="fas fa-shield-alt"></i> 
                                Institutional Quality Validation
                                {% if quality_validation.score %}
                                <span class="badge {% if quality_validation.score >= 8.0 %}bg-success{% elif quality_validation.score >= 7.0 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
                                    {{ quality_validation.score|round(1) }}/10
                                    {% if quality_validation.quality_grade %}({{ quality_validation.quality_grade }}){% endif %}
                                </span>
                                {% endif %}
                            </h6>
                            <small class="text-muted">
                                {% if quality_validation.passed %}
                                ✅ Analysis validated for fact accuracy, valuation context, and investment actionability
                                {% elif quality_validation.passed == False %}
                                ⚠️ Quality issues detected and corrected automatically
                                {% else %}
                                ℹ️ Quality validation in progress
                                {% endif %}
                                
                                {% if quality_validation.enhancements_made %}
                                • {{ quality_validation.enhancements_made|length }} enhancements applied
                                {% endif %}
                                
                                {% if quality_validation.critical_issues %}
                                • {{ quality_validation.critical_issues|length }} issues resolved
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if quality_validation.score %}
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar 
                                    {% if quality_validation.score >= 8.0 %}bg-success
                                    {% elif quality_validation.score >= 7.0 %}bg-warning  
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ quality_validation.score * 10 }}%"></div>
                            </div>
                            <small class="text-muted">
                                Target: 8.0+ (Institutional Grade)
                            </small>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Quality Details Expandable Section -->
                    {% if quality_validation.gate_scores or quality_validation.critical_issues %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#qualityDetails" aria-expanded="false">
                            <i class="fas fa-chart-bar"></i> View Quality Details
                        </button>
                        
                        <div class="collapse mt-2" id="qualityDetails">
                            {% if quality_validation.gate_scores %}
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted"><strong>Quality Dimensions:</strong></small>
                                    <div class="row">
                                        {% for gate, score in quality_validation.gate_scores.items() %}
                                        <div class="col-md-2 col-6">
                                            <div class="text-center">
                                                <div class="small fw-bold">{{ score|round(1) }}/10</div>
                                                <div class="small text-muted">{{ gate.replace('_', ' ').title() }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if quality_validation.critical_issues %}
                            <div class="mt-2">
                                <small class="text-muted"><strong>Issues Resolved:</strong></small>
                                <ul class="small mb-0 mt-1">
                                    {% for issue in quality_validation.critical_issues[:3] %}
                                    <li class="text-muted">
                                        <span class="badge badge-sm {% if issue.severity == 'high' %}bg-danger{% elif issue.severity == 'medium' %}bg-warning{% else %}bg-info{% endif %}">
                                            {{ issue.severity }}
                                        </span>
                                        {{ issue.category.replace('_', ' ').title() }}: {{ issue.issue|truncate(80) }}
                                    </li>
                                    {% endfor %}
                                    {% if quality_validation.critical_issues|length > 3 %}
                                    <li class="text-muted">... and {{ quality_validation.critical_issues|length - 3 }} more issues resolved</li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Enhanced Source Breakdown -->
                <div class="source-breakdown">
                    <div class="row text-center">
                        <div class="col-12 mb-3">
                            <h5 class="mb-0"><i class="fas fa-database"></i> Premium Sources Breakdown</h5>
                            <small>Multi-source institutional analysis powered by APIs and premium feeds</small>
                        </div>
                    </div>
                    
                    <div class="row justify-content-center">
                        {% if alphavantage_articles > 0 %}
                        <div class="col-md-3 col-6">
                            <div class="metric-card text-center">
                                <div class="h4 text-purple mb-1">{{ alphavantage_articles }}</div>
                                <small><i class="fas fa-brain"></i> AlphaVantage</small>
                                <div class="small text-muted">Sentiment + Full Content</div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-purple" style="width: {{ alphavantage_coverage }}%"></div>
                                </div>
                                <small class="text-muted">{{ alphavantage_coverage|default(0)|round }}%</small>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if nyt_articles is defined and nyt_articles > 0 %}
                        <div class="col-md-3 col-6">
                            <div class="metric-card text-center">
                                <div class="h4 text-warning mb-1">{{ nyt_articles }}</div>
                                <small><i class="fas fa-newspaper"></i> NYT API</small>
                                <div class="small text-muted">Full Abstracts</div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-warning" style="width: {{ (nyt_articles / article_count * 100) | round }}%"></div>
                                </div>
                                <small class="text-muted">{{ (nyt_articles / article_count * 100) | round }}%</small>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if rss_articles is defined and rss_articles > 0 %}
                        <div class="col-md-3 col-6">
                            <div class="metric-card text-center">
                                <div class="h4 text-info mb-1">{{ rss_articles }}</div>
                                <small><i class="fas fa-rss"></i> RSS Feeds</small>
                                <div class="small text-muted">Premium Feeds</div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-info" style="width: {{ (rss_articles / article_count * 100) | round }}%"></div>
                                </div>
                                <small class="text-muted">{{ (rss_articles / article_count * 100) | round }}%</small>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-3 col-6">
                            <div class="metric-card text-center">
                                <div class="h4 text-success mb-1">{{ high_quality_sources }}</div>
                                <small><i class="fas fa-star"></i> Premium</small>
                                <div class="small text-muted">Bloomberg, Reuters, WSJ</div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-success" style="width: {{ premium_coverage }}%"></div>
                                </div>
                                <small class="text-muted">{{ premium_coverage|default(0)|round }}%</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="card analysis-section executive-section">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-briefcase"></i> Executive Summary
                        </h5>
                        <small>Strategic developments and fundamental business outlook</small>
                    </div>
                    <div class="card-body">
                        {% if summaries.executive %}
                            {% for bullet in summaries.executive %}
                            <div class="insight-bullet">
                                <i class="fas fa-chevron-right text-success me-2"></i>
                                {{ bullet|safe }}
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No significant executive developments identified.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Investor Insights -->
                <div class="card analysis-section investor-section">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar"></i> Investor Insights
                        </h5>
                        <small>Valuation drivers, analyst actions, and market sentiment</small>
                    </div>
                    <div class="card-body">
                        {% if summaries.investor %}
                            {% for bullet in summaries.investor %}
                            <div class="insight-bullet">
                                <i class="fas fa-chevron-right text-primary me-2"></i>
                                {{ bullet|safe }}
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No significant investor developments identified.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Catalysts & Risks -->
                <div class="card analysis-section catalysts-section">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i> Catalysts & Risks
                        </h5>
                        <small>Near-term trading catalysts and risk factors</small>
                    </div>
                    <div class="card-body">
                        {% if summaries.catalysts %}
                            {% for bullet in summaries.catalysts %}
                            <div class="insight-bullet">
                                <i class="fas fa-chevron-right text-danger me-2"></i>
                                {{ bullet|safe }}
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted mb-0">No significant catalysts or risks identified.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Enhanced Source Articles with Type Indicators -->
                {% if articles %}
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-newspaper"></i> Source Articles
                            <span class="badge bg-secondary ms-2">{{ article_count }} analyzed</span>
                            <small class="text-muted">(showing top 4, expand for all {{ article_count }})</small>
                        </h5>
                        <small class="text-muted">Premium articles ranked by relevance, source quality, and content depth</small>
                    </div>
                    <div class="card-body">
                        <!-- Top 4 Articles (Always Visible) -->
                        <div id="topArticles">
                            {% for article in articles[:4] %}
                            <div class="article-item priority-article">
                                <!-- Keep existing article display code unchanged -->
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <!-- Priority Badge -->
                                            <span class="badge bg-primary badge-sm me-2">Top {{ loop.index }}</span>
                                            
                                            <!-- Enhanced Source Type Indicators -->
                                            {% if article.source_type == 'alphavantage_premium' %}
                                            <span class="alphavantage-source">
                                                <i class="fas fa-brain me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-purple badge-sm">Full Content + Sentiment</span>
                                            {% if article.sentiment_label %}
                                            <span class="badge 
                                                {% if article.sentiment_label == 'Bullish' %}bg-success
                                                {% elif article.sentiment_label == 'Bearish' %}bg-danger
                                                {% else %}bg-secondary{% endif %} badge-sm ms-1">
                                                {{ article.sentiment_label }}
                                                {% if article.sentiment_score %}({{ article.sentiment_score|round(1) }}){% endif %}
                                            </span>
                                            {% endif %}
                                            
                                            {% elif article.source_type == 'nyt_api' %}
                                            <span class="nyt-source">
                                                <i class="fas fa-newspaper me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-warning badge-sm">NYT API + Full Abstract</span>
                                            
                                            {% elif article.source_type == 'rss_feed' %}
                                            <span class="rss-source">
                                                <i class="fas fa-rss me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-info badge-sm">RSS Premium Feed</span>
                                            
                                            {% elif article.source in ['bloomberg.com', 'reuters.com', 'wsj.com', 'ft.com'] %}
                                            <span class="premium-source">
                                                <i class="fas fa-crown me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-success badge-sm">Premium Source</span>
                                            
                                            {% else %}
                                            <span class="standard-source">
                                                <i class="fas fa-globe me-1"></i>{{ article.source }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <h6 class="mb-1">
                                            <a href="{{ article.link }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none priority-link">
                                                {{ article.title }}
                                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.7rem;"></i>
                                            </a>
                                        </h6>
                                        <p class="mb-2 text-muted small">{{ article.snippet }}</p>
                                        
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <!-- Content Quality Indicator -->
                                            {% if article.get('full_content') and (article.get('full_content')|length > 200) %}
                                            <span class="badge bg-light text-dark badge-sm">
                                                <i class="fas fa-file-text"></i> Full Content
                                            </span>
                                            {% endif %}
                                            
                                            <!-- Enhanced Badge -->
                                            {% if article.get('enhanced') %}
                                            <span class="badge bg-success badge-sm">
                                                <i class="fas fa-magic"></i> Enhanced
                                            </span>
                                            {% endif %}
                                            
                                            <!-- Relevance Score for AlphaVantage -->
                                            {% if article.source_type == 'alphavantage_premium' and article.get('relevance_score') %}
                                            <span class="badge bg-light text-dark badge-sm">
                                                Relevance: {{ article.relevance_score|round(2) }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Expandable Section for Remaining Articles -->
                        {% set remaining_articles = articles[4:] %}
                        {% if remaining_articles|length > 0 %}
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#remainingArticles" aria-expanded="false" aria-controls="remainingArticles" id="expandArticlesBtn">
                                <i class="fas fa-chevron-down me-2"></i>
                                Show Remaining {{ remaining_articles|length }} Articles
                                <small class="text-muted ms-2">({{ remaining_articles|length }} additional sources)</small>
                            </button>
                        </div>
                        
                        <div class="collapse mt-3" id="remainingArticles">
                            <hr class="my-3">
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-list me-2"></i>Additional Sources (Articles 5-{{ article_count }})
                                        <small class="text-muted">- Comprehensive coverage from all premium sources</small>
                                    </h6>
                                </div>
                            </div>
                            
                            <!-- Grid Layout for Remaining Articles -->
                            <div class="row">
                                {% for article in remaining_articles %}
                                <div class="col-md-6 mb-3">
                                    <div class="additional-article p-3 border rounded">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-light text-dark badge-sm me-2">#{{ loop.index + 4 }}</span>
                                            
                                            <!-- Compact Source Indicators -->
                                            {% if article.source_type == 'alphavantage_premium' %}
                                            <span class="badge bg-purple badge-sm">
                                                <i class="fas fa-brain"></i> AV+Sentiment
                                            </span>
                                            {% elif article.source_type == 'nyt_api' %}
                                            <span class="badge bg-warning badge-sm">
                                                <i class="fas fa-newspaper"></i> NYT
                                            </span>
                                            {% elif article.source_type == 'rss_feed' %}
                                            <span class="badge bg-info badge-sm">
                                                <i class="fas fa-rss"></i> RSS
                                            </span>
                                            {% elif article.source in ['bloomberg.com', 'reuters.com', 'wsj.com', 'ft.com'] %}
                                            <span class="badge bg-success badge-sm">
                                                <i class="fas fa-crown"></i> Premium
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <h6 class="mb-2" style="font-size: 0.9rem; line-height: 1.3;">
                                            <a href="{{ article.link }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                                {{ article.title|truncate(80) }}
                                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.6rem;"></i>
                                            </a>
                                        </h6>
                                        
                                        <p class="mb-2 text-muted" style="font-size: 0.8rem;">
                                            {{ article.snippet|truncate(120) }}
                                        </p>
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-globe me-1"></i>{{ article.source }}
                                            </small>
                                            
                                            {% if article.source_type == 'alphavantage_premium' and article.get('sentiment_label') %}
                                            <span class="badge 
                                                {% if article.sentiment_label == 'Bullish' %}bg-success
                                                {% elif article.sentiment_label == 'Bearish' %}bg-danger
                                                {% else %}bg-secondary{% endif %} badge-sm">
                                                {{ article.sentiment_label }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Article Statistics -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-chart-bar me-2"></i>Complete Article Breakdown (All {{ article_count }})</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <strong>AlphaVantage:</strong> {{ alphavantage_articles }} articles<br>
                                                <small class="text-muted">Full content + sentiment analysis</small>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>NYT API:</strong> {{ nyt_articles }} articles<br>
                                                <small class="text-muted">Full abstracts + editorial quality</small>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Premium RSS:</strong> {{ rss_articles }} articles<br>
                                                <small class="text-muted">Bloomberg, Reuters, WSJ feeds</small>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Premium Sources:</strong> {{ high_quality_sources }} articles<br>
                                                <small class="text-muted">{{ premium_coverage }}% coverage</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <style>
                /* Additional CSS for enhanced article display */
                .priority-article {
                    border-left: 3px solid #007bff;
                    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
                    padding: 1rem;
                    margin-bottom: 1rem;
                    border-radius: 8px;
                }

                .priority-link {
                    font-weight: 600;
                    color: #0d47a1 !important;
                }

                .additional-article {
                    transition: transform 0.2s, box-shadow 0.2s;
                    height: 100%;
                }

                .additional-article:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }

                .bg-purple { 
                    background-color: #6f42c1 !important; 
                }

                .alphavantage-source { 
                    color: #6f42c1; 
                    font-weight: 600; 
                }

                .nyt-source { 
                    color: #fd7e14; 
                    font-weight: 600; 
                }

                .rss-source { 
                    color: #20c997; 
                    font-weight: 600; 
                }

                .premium-source { 
                    color: #28a745; 
                    font-weight: 600; 
                }

                .standard-source { 
                    color: #6c757d; 
                }

                /* Collapse button animation */
                #expandArticlesBtn[aria-expanded="true"] .fa-chevron-down {
                    transform: rotate(180deg);
                    transition: transform 0.3s ease;
                }

                #expandArticlesBtn[aria-expanded="false"] .fa-chevron-down {
                    transform: rotate(0deg);
                    transition: transform 0.3s ease;
                }
                </style>

                <script>
                // Update button text when expanded/collapsed - FIXED VERSION
                document.getElementById('expandArticlesBtn').addEventListener('click', function() {
                    const remainingCount = {{ remaining_articles|length }};
                    const totalCount = {{ article_count }};
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    
                    if (isExpanded) {
                        // Will be collapsed after click
                        setTimeout(() => {
                            this.innerHTML = `<i class="fas fa-chevron-down me-2"></i>Show Remaining ${remainingCount} Articles <small class="text-muted ms-2">(${remainingCount} additional sources)</small>`;
                        }, 300);
                    } else {
                        // Will be expanded after click
                        setTimeout(() => {
                            this.innerHTML = `<i class="fas fa-chevron-up me-2"></i>Hide Additional Articles <small class="text-muted ms-2">(showing all ${totalCount})</small>`;
                        }, 300);
                    }
                });
                </script>
                {% endif %}

                <!-- Enhanced Analysis Methodology -->
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> Enhanced Analysis Methodology</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="mb-0 small">
                                <li><strong>Data Sources:</strong> 
                                    {% if alphavantage_articles > 0 %}AlphaVantage API ({{ alphavantage_articles }} with sentiment), {% endif %}
                                    {% if nyt_articles is defined and nyt_articles > 0 %}NYT API ({{ nyt_articles }} abstracts), {% endif %}
                                    {% if rss_articles is defined and rss_articles > 0 %}Premium RSS ({{ rss_articles }} feeds), {% endif %}
                                    Google Search fallback
                                </li>
                                <li><strong>Content Quality:</strong> {{ alphavantage_coverage|default(0)|round }}% full content, {{ premium_coverage|default(0)|round }}% premium sources</li>
                                <li><strong>Analysis Features:</strong> 
                                    {% if alphavantage_articles > 0 %}Sentiment analysis, relevance scoring, {% endif %}
                                    quantified financial impacts, trading context
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0 small">
                                <li><strong>Processing:</strong> {{ articles_analyzed|default(article_count) }} articles analyzed, {{ articles_displayed|default(8) }} top articles displayed</li>
                                
                                <!-- Enhanced Quality Information -->
                                {% if quality_validation and quality_validation.enabled %}
                                <li><strong>Quality Validation:</strong> 
                                    {% if quality_validation.score %}
                                    {{ quality_validation.score|round(1) }}/10 
                                    ({{ quality_validation.quality_grade or 'Graded' }})
                                    {% else %}
                                    Enabled
                                    {% endif %}
                                    - Fact verification, valuation context, investment actionability
                                </li>
                                {% endif %}
                                
                                <li><strong>Analysis Grade:</strong> {{ analysis_quality }} - 
                                    {% if analysis_quality == 'Premium+' %}Multi-source with sentiment analysis
                                    {% elif analysis_quality == 'Institutional' %}Premium sources with quantified impacts
                                    {% elif analysis_quality == 'Professional' %}Enhanced analysis with business context
                                    {% else %}Comprehensive analysis of available data{% endif %}
                                </li>
                                <li><strong>Source Diversity:</strong> {{ (source_performance.values() | list | length) if source_performance else "Multiple" }} premium data sources integrated</li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                {% if quality_validation and quality_validation.enabled %}
                                <strong>Quality Assurance:</strong> All analyses undergo institutional-grade validation including fact verification, valuation context assessment, and investment actionability review. 
                                {% endif %}
                                <strong>Limitations:</strong> Premium paywalled content limited to excerpts unless available via APIs. 
                                <strong>Disclaimer:</strong> For informational purposes only. Not investment advice. 
                                Consult latest SEC filings and qualified financial advisors.
                                <strong>Data Freshness:</strong> Analysis generated on {{ analysis_timestamp or "recent request" }}.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="text-center mt-4 mb-5">
                    <a href="/news" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Analyze Another Company
                    </a>
                    <button onclick="window.print()" class="btn btn-outline-secondary">
                        <i class="fas fa-print"></i> Print Analysis
                    </button>
                    <button onclick="exportAnalysis()" class="btn btn-outline-info">
                        <i class="fas fa-download"></i> Export Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function exportAnalysis() {
            const company = {{ company|tojson }};
            const dateRange = "{{ date_range }}";
            const analysisQuality = "{{ analysis_quality }}";
            const sourceBreakdown = {
                total: {{ article_count }},
                alphavantage: {{ alphavantage_articles|default(0) }},
                nyt: {{ nyt_articles|default(0) }},
                rss: {{ rss_articles|default(0) }},
                premium: {{ high_quality_sources|default(0) }}
            };
            
            let text = `PREMIUM FINANCIAL ANALYSIS: ${company}\n`;
            text += `Analysis Quality: ${analysisQuality}\n`;
            text += `Date Range: ${dateRange}\n`;
            text += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            text += `SOURCE BREAKDOWN:\n`;
            text += `• Total Articles: ${sourceBreakdown.total}\n`;
            if (sourceBreakdown.alphavantage > 0) text += `• AlphaVantage (Full Content + Sentiment): ${sourceBreakdown.alphavantage}\n`;
            if (sourceBreakdown.nyt > 0) text += `• NYT API (Full Abstracts): ${sourceBreakdown.nyt}\n`;
            if (sourceBreakdown.rss > 0) text += `• Premium RSS Feeds: ${sourceBreakdown.rss}\n`;
            text += `• Premium Sources Total: ${sourceBreakdown.premium}\n\n`;
            
            // Add summaries
            text += "EXECUTIVE SUMMARY:\n";
            {% for bullet in summaries.executive %}
            text += "• {{ bullet|striptags }}\n";
            {% endfor %}
            
            text += "\nINVESTOR INSIGHTS:\n";
            {% for bullet in summaries.investor %}
            text += "• {{ bullet|striptags }}\n";
            {% endfor %}
            
            text += "\nCATALYSTS & RISKS:\n";
            {% for bullet in summaries.catalysts %}
            text += "• {{ bullet|striptags }}\n";
            {% endfor %}
            
            text += "\n" + "=".repeat(50) + "\n";
            text += "Analysis powered by premium financial data sources\n";
            text += "Generated by institutional-grade news analysis system\n";
            
            // Create download
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${company.replace(/\s+/g, '_')}_premium_analysis_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Print styles
        window.addEventListener('beforeprint', function() {
            document.querySelector('.back-button').style.display = 'none';
            document.querySelector('.source-breakdown').style.background = '#f8f9fa';
            document.querySelector('.source-breakdown').style.color = '#000';
        });
        
        window.addEventListener('afterprint', function() {
            document.querySelector('.back-button').style.display = 'block';
            document.querySelector('.source-breakdown').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            document.querySelector('.source-breakdown').style.color = 'white';
        });
        
        // Add purple color for AlphaVantage branding
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .bg-purple { background-color: #6f42c1 !important; }
                .text-purple { color: #6f42c1 !important; }
                .badge.bg-purple { background-color: #6f42c1 !important; }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>