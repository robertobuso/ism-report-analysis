{% extends "base.html" %}

{% block title %}{{ company }} - Premium Financial Analysis{% endblock %}

{% block extra_styles %}
    <style>
        .analysis-section {
            margin-bottom: 1.5rem;
        }
        .executive-section { border-left: 4px solid var(--color-accent-green); }
        .investor-section { border-left: 4px solid var(--color-accent-blue); }
        .catalysts-section { border-left: 4px solid var(--color-accent-red); }
        
        .quality-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .source-link {
            color: #6c757d;
            text-decoration: none;
            font-size: 0.85rem;
        }
        
        .source-link:hover {
            color: #007bff;
            text-decoration: underline;
        }
        
        .article-item {
            border-bottom: 1px solid #dee2e6;
            padding: 0.75rem 0;
        }
        
        .article-item:last-child {
            border-bottom: none;
        }
        
        .premium-source {
            color: #28a745;
            font-weight: 600;
        }
        
        .alphavantage-source {
            color: #6f42c1;
            font-weight: 600;
        }
        
        .nyt-source {
            color: #fd7e14;
            font-weight: 600;
        }
        
        .rss-source {
            color: #20c997;
            font-weight: 600;
        }
        
        .standard-source {
            color: #6c757d;
        }
        
        .insight-bullet {
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }
        
        .back-button {
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
        }

        .progress-thin {
            height: 6px;
            border-radius: 3px;
        }

        .badge.bg-purple { 
            background-color: #6f42c1 !important; 
        }

        .source-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.3rem;
            margin-left: 0.2rem;
            text-decoration: none !important;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.15rem;
            white-space: nowrap;
            vertical-align: middle;
            border-radius: 3px;
        }

        .source-badge:hover {
            opacity: 0.8;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .bg-purple { 
            background-color: #6f42c1 !important; 
            color: white !important;
        }

        /* Ensure badges don't break awkwardly */
        .insight-bullet {
            line-height: 1.6;
            word-wrap: break-word;
        }

        /* Ensure badges don't break line flow */
        .insight-bullet .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.2rem;
            white-space: nowrap;
            vertical-align: middle;
        }
 
        .formatted-response p {
            margin-bottom: 0.75rem;
            line-height: 1.6;
        }

        .formatted-response p:last-child {
            margin-bottom: 0;
        }

        .formatted-response strong {
            font-weight: 600;
            color: #2c3e50;
        }

        .formatted-response em {
            font-style: italic;
            color: #5a6c7d;
        }
        
        @media (max-width: 768px) {
            .back-button {
                position: relative;
                top: 0;
                left: 0;
                margin-bottom: 1rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- Back Button -->
        <a href="/news" class="ds-btn-secondary back-button d-inline-flex align-items-center gap-2">
            <i data-lucide="arrow-left" style="width: 16px; height: 16px;"></i>
            New Analysis
        </a>

        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-8">
                <!-- Enhanced Header with Premium Metrics -->
                <div class="text-center mb-4 mt-4">
                    <h2 class="ds-page-title mb-3 d-flex align-items-center justify-content-center gap-2">
                        <i data-lucide="trending-up" style="width: 28px; height: 28px;" class="text-primary"></i>
                        Financial Analysis: {{ company }}
                    </h2>
                    <div class="d-flex justify-content-center align-items-center gap-3 flex-wrap">
                        <span class="badge bg-secondary">{{ date_range }}</span>
                        <span class="badge quality-badge 
                            {% if analysis_quality == 'Premium+' %}bg-success
                            {% elif analysis_quality == 'Institutional' %}bg-primary
                            {% elif analysis_quality == 'Professional' %}bg-info
                            {% elif analysis_quality == 'Standard' %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {{ metrics.analysis_quality }} Grade
                        </span>
                        <span class="text-muted">
                            <i class="fas fa-newspaper"></i> {{ metrics.total_articles }} articles
                        </span>
                    </div>
                    
                    <!-- Enhanced Analysis Quality Description -->
                    {% if analysis_quality == 'Premium+' %}
                    <small class="text-success d-block mt-2">
                        <i class="fas fa-crown"></i> Premium+ analysis with AlphaVantage sentiment data + NYT full abstracts + premium RSS feeds
                    </small>
                    {% elif analysis_quality == 'Institutional' %}
                    <small class="text-primary d-block mt-2">
                        <i class="fas fa-university"></i> Institutional-grade analysis with quantified impacts and multiple premium sources
                    </small>
                    {% elif analysis_quality == 'Professional' %}
                    <small class="text-info d-block mt-2">
                        <i class="fas fa-briefcase"></i> Professional-grade analysis with enhanced content and business context
                    </small>
                    {% elif analysis_quality == 'Standard' %}
                    <small class="text-warning d-block mt-2">
                        <i class="fas fa-info-circle"></i> Standard analysis with premium source coverage
                    </small>
                    {% else %}
                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-exclamation-triangle"></i> Limited sources - comprehensive analysis of available data
                    </small>
                    {% endif %}
                </div>

                <!-- Quality Validation Display -->
                {% if quality_validation and quality_validation.enabled %}
                <div class="alert {% if quality_validation.passed %}alert-success{% elif quality_validation.passed == False %}alert-warning{% else %}alert-info{% endif %} mb-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="mb-1">
                                <i class="fas fa-shield-alt"></i> 
                                Institutional Quality Validation
                                {% if quality_validation.score %}
                                <span class="badge {% if quality_validation.score >= 8.0 %}bg-success{% elif quality_validation.score >= 7.0 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
                                    {{ quality_validation.score|round(1) }}/10
                                    {% if quality_validation.quality_grade %}({{ quality_validation.quality_grade }}){% endif %}
                                </span>
                                {% endif %}
                            </h6>
                            <small class="text-muted">
                                {% if quality_validation.passed %}
                                ✅ Analysis validated for fact accuracy, valuation context, and investment actionability
                                {% elif quality_validation.passed == False %}
                                ⚠️ Quality issues detected and corrected automatically
                                {% else %}
                                ℹ️ Quality validation in progress
                                {% endif %}
                                
                                {% if quality_validation.enhancements_made %}
                                • {{ quality_validation.enhancements_made|length }} enhancements applied
                                {% endif %}
                                
                                {% if quality_validation.critical_issues %}
                                • {{ quality_validation.critical_issues|length }} issues resolved
                                {% endif %}
                            </small>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if quality_validation.score %}
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar 
                                    {% if quality_validation.score >= 8.0 %}bg-success
                                    {% elif quality_validation.score >= 7.0 %}bg-warning  
                                    {% else %}bg-danger{% endif %}" 
                                    style="width: {{ quality_validation.score * 10 }}%"></div>
                            </div>
                            <small class="text-muted">
                                Target: 8.0+ (Institutional Grade)
                            </small>
                            {% endif %}

                             <!-- NEW: Show iterative improvements -->
                            {% if quality_validation.improvement_analysis %}
                            <small>Iterations: {{ quality_validation.improvement_analysis.attempt }}, 
                                Trajectory: {{ quality_validation.improvement_analysis.trajectory }}</small>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Quality Details Expandable Section -->
                    {% if quality_validation.gate_scores or quality_validation.critical_issues %}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#qualityDetails" aria-expanded="false">
                            <i class="fas fa-chart-bar"></i> View Quality Details
                        </button>
                        
                        <div class="collapse mt-2" id="qualityDetails">
                            {% if quality_validation.gate_scores %}
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-muted"><strong>Quality Dimensions:</strong></small>
                                    <div class="row">
                                        {% for gate, score in quality_validation.gate_scores.items() %}
                                        <div class="col-md-2 col-6">
                                            <div class="text-center">
                                                <div class="small fw-bold">{{ score|round(1) }}/10</div>
                                                <div class="small text-muted">{{ gate.replace('_', ' ').title() }}</div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if quality_validation.critical_issues %}
                            <div class="mt-2">
                                <small class="text-muted"><strong>Issues Resolved:</strong></small>
                                <ul class="small mb-0 mt-1">
                                    {% for issue in quality_validation.critical_issues[:3] %}
                                    <li class="text-muted">
                                        <span class="badge badge-sm {% if issue.severity == 'high' %}bg-danger{% elif issue.severity == 'medium' %}bg-warning{% else %}bg-info{% endif %}">
                                            {{ issue.severity }}
                                        </span>
                                        {{ issue.category.replace('_', ' ').title() }}: {{ issue.issue|truncate(80) }}
                                    </li>
                                    {% endfor %}
                                    {% if quality_validation.critical_issues|length > 3 %}
                                    <li class="text-muted">... and {{ quality_validation.critical_issues|length - 3 }} more issues resolved</li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% if raw_model_preview %}
                <div class="mt-3">
                <button class="btn btn-sm btn-outline-dark" type="button"
                        data-bs-toggle="collapse" data-bs-target="#rawModel"
                        aria-expanded="false" aria-controls="rawModel">
                    <i class="fas fa-bug me-1"></i> Debug: Show Raw Model Output
                </button>
                <div id="rawModel" class="collapse mt-2">
                    <pre class="small bg-light p-2 border rounded" style="max-height:300px; overflow:auto; white-space:pre-wrap;">{{ raw_model_preview }}</pre>
                </div>
                </div>
                {% endif %}


                <!-- Enhanced Source Breakdown -->
                <div class="ds-card ds-card-accent-purple mb-4">
                    <div class="text-center mb-3">
                        <h5 class="ds-section-title mb-2 d-flex align-items-center justify-content-center gap-2">
                            <i data-lucide="database" style="width: 20px; height: 20px;"></i>
                            Premium Sources Breakdown
                        </h5>
                        <small class="ds-muted">Multi-source institutional analysis powered by APIs and premium feeds</small>
                    </div>

                    <div class="row justify-content-center">
                        {% if metrics.alphavantage_articles > 0 %}
                        <div class="col-md-3 col-6">
                            <div class="ds-kpi-card text-center">
                                <div class="h4 mb-1" style="color: var(--color-accent-purple);">{{ metrics.alphavantage_articles }}</div>
                                <small class="d-flex align-items-center justify-content-center gap-1 mb-1">
                                    <i data-lucide="brain" style="width: 14px; height: 14px;"></i>
                                    AlphaVantage
                                </small>
                                <div class="small ds-muted">Sentiment + Full Content</div>
                                <div class="progress progress-thin mt-2" style="background: var(--color-border-light);">
                                    <div class="progress-bar" style="background: var(--color-accent-purple); width: {{ metrics.alphavantage_coverage }}%"></div>
                                </div>
                                <small class="ds-muted">{{ metrics.alphavantage_coverage|default(0)|round }}%</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if metrics.nyt_articles is defined and metrics.nyt_articles > 0 %}
                        <div class="col-md-3 col-6">
                            <div class="ds-kpi-card text-center">
                                <div class="h4 mb-1" style="color: var(--color-accent-warning);">{{ metrics.nyt_articles }}</div>
                                <small class="d-flex align-items-center justify-content-center gap-1 mb-1">
                                    <i data-lucide="newspaper" style="width: 14px; height: 14px;"></i>
                                    NYT API
                                </small>
                                <div class="small ds-muted">Full Abstracts</div>
                                <div class="progress progress-thin mt-2" style="background: var(--color-border-light);">
                                    <div class="progress-bar" style="background: var(--color-accent-warning); width: {{ (metrics.nyt_articles / metrics.total_articles * 100) | round }}%"></div>
                                </div>
                                <small class="ds-muted">{{ (metrics.nyt_articles / metrics.total_articles * 100) | round }}%</small>
                            </div>
                        </div>
                        {% endif %}

                        {% if metrics.rss_articles is defined and metrics.rss_articles > 0 %}
                        <div class="col-md-3 col-6">
                            <div class="ds-kpi-card text-center">
                                <div class="h4 mb-1" style="color: var(--color-accent-blue);">{{ metrics.rss_articles }}</div>
                                <small class="d-flex align-items-center justify-content-center gap-1 mb-1">
                                    <i data-lucide="rss" style="width: 14px; height: 14px;"></i>
                                    RSS Feeds
                                </small>
                                <div class="small ds-muted">Premium Feeds</div>
                                <div class="progress progress-thin mt-2" style="background: var(--color-border-light);">
                                    <div class="progress-bar" style="background: var(--color-accent-blue); width: {{ (metrics.rss_articles / metrics.total_articles * 100) | round }}%"></div>
                                </div>
                                <small class="ds-muted">{{ (metrics.rss_articles / metrics.total_articles * 100) | round }}%</small>
                            </div>
                        </div>
                        {% endif %}

                        <div class="col-md-3 col-6">
                            <div class="ds-kpi-card text-center">
                                <div class="h4 mb-1" style="color: var(--color-accent-green);">{{ metrics.high_quality_sources }}</div>
                                <small class="d-flex align-items-center justify-content-center gap-1 mb-1">
                                    <i data-lucide="star" style="width: 14px; height: 14px;"></i>
                                    Premium
                                </small>
                                <div class="small ds-muted">Bloomberg, Reuters, WSJ</div>
                                <div class="progress progress-thin mt-2" style="background: var(--color-border-light);">
                                    <div class="progress-bar bg-success" style="width: {{ metrics.premium_coverage }}%"></div>
                                </div>
                                <small class="ds-muted">{{ metrics.premium_coverage|default(0)|round }}%</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="ds-card analysis-section executive-section">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="briefcase" style="width: 18px; height: 18px;"></i>
                            Executive Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if summaries.executive %}
                            {% for bullet_data in summaries.executive %}
                            <div class="insight-bullet">
                                <i class="fas fa-chevron-right text-success me-2"></i>
                                {# Render the bullet text #}
                                {{ bullet_data.text | safe }}

                                {# Render the citation badges #}
                                {% if bullet_data.citations %}
                                    {% for citation in bullet_data.citations %}
                                        <a href="{{ citation.url }}" target="_blank" rel="noopener"
                                           class="badge bg-secondary text-decoration-none source-badge"
                                           title="Source: {{ citation.title }}">
                                            <i class="fas fa-link"></i> {{ citation.source | truncate(15) }}
                                        </a>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Investor Insights (repeat the same pattern) -->
                <div class="ds-card analysis-section investor-section">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="bar-chart-3" style="width: 18px; height: 18px;"></i>
                            Investor Insights
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if summaries.investor %}
                            {% for bullet_data in summaries.investor %}
                            <div class="insight-bullet">
                                <i class="fas fa-chevron-right text-primary me-2"></i>
                                {{ bullet_data.text | safe }}
                                {% if bullet_data.citations %}
                                    {% for citation in bullet_data.citations %}
                                        <a href="{{ citation.url }}" target="_blank" rel="noopener"
                                           class="badge bg-secondary text-decoration-none source-badge"
                                           title="Source: {{ citation.title }}">
                                            <i class="fas fa-link"></i> {{ citation.source | truncate(15) }}
                                        </a>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Catalysts & Risks (repeat the same pattern) -->
                <div class="ds-card analysis-section catalysts-section">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="alert-triangle" style="width: 18px; height: 18px;"></i>
                            Catalysts & Risks
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if summaries.catalysts %}
                            {% for bullet_data in summaries.catalysts %}
                            <div class="insight-bullet">
                                <i class="fas fa-chevron-right text-danger me-2"></i>
                                {{ bullet_data.text | safe }}
                                {% if bullet_data.citations %}
                                    {% for citation in bullet_data.citations %}
                                        <a href="{{ citation.url }}" target="_blank" rel="noopener"
                                           class="badge bg-secondary text-decoration-none source-badge"
                                           title="Source: {{ citation.title }}">
                                            <i class="fas fa-link"></i> {{ citation.source | truncate(15) }}
                                        </a>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Enhanced Source Articles with Type Indicators -->
                {% if articles %}
                <div class="card mt-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="fas fa-newspaper"></i> Source Articles
                            <span class="badge bg-secondary ms-2">{{ metrics.total_articles }} analyzed</span>
                            <small class="text-muted">(showing top 4, expand for all {{ metrics.total_articles }})</small>
                        </h5>
                        <small class="text-muted">Premium articles ranked by relevance, source quality, and content depth</small>
                    </div>
                    <div class="card-body">
                        <!-- Top 4 Articles (Always Visible) -->
                        <div id="topArticles">
                            {% for article in articles[:4] %}
                            <div class="article-item priority-article">
                                <!-- Keep existing article display code unchanged -->
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <!-- Priority Badge -->
                                            <span class="badge bg-primary badge-sm me-2">Top {{ loop.index }}</span>
                                            
                                            <!-- Enhanced Source Type Indicators -->
                                            {% if article.source_type == 'alphavantage_premium' %}
                                            <span class="alphavantage-source">
                                                <i class="fas fa-brain me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-purple badge-sm">Full Content + Sentiment</span>
                                            {% if article.sentiment_label %}
                                            <span class="badge 
                                                {% if article.sentiment_label == 'Bullish' %}bg-success
                                                {% elif article.sentiment_label == 'Bearish' %}bg-danger
                                                {% else %}bg-secondary{% endif %} badge-sm ms-1">
                                                {{ article.sentiment_label }}
                                                {% if article.sentiment_score %}({{ article.sentiment_score|round(1) }}){% endif %}
                                            </span>
                                            {% endif %}
                                            
                                            {% elif article.source_type == 'nyt_api' %}
                                            <span class="nyt-source">
                                                <i class="fas fa-newspaper me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-warning badge-sm">NYT API + Full Abstract</span>
                                            
                                            {% elif article.source_type == 'rss_feed' %}
                                            <span class="rss-source">
                                                <i class="fas fa-rss me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-info badge-sm">RSS Premium Feed</span>
                                            
                                            {% elif article.source in ['bloomberg.com', 'reuters.com', 'wsj.com', 'ft.com'] %}
                                            <span class="premium-source">
                                                <i class="fas fa-crown me-1"></i>{{ article.source }}
                                            </span>
                                            <span class="badge bg-success badge-sm">Premium Source</span>
                                            
                                            {% else %}
                                            <span class="standard-source">
                                                <i class="fas fa-globe me-1"></i>{{ article.source }}
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <h6 class="mb-1">
                                            <a href="{{ article.link or article.url or article.web_url or '#' }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none priority-link">
                                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.7rem;"></i>
                                            </a>
                                        </h6>
                                        <p class="mb-2 text-muted small">{{ article.snippet }}</p>
                                        
                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                            <!-- Content Quality Indicator -->
                                            {% if article.get('full_content') and (article.get('full_content')|length > 200) %}
                                            <span class="badge bg-light text-dark badge-sm">
                                                <i class="fas fa-file-text"></i> Full Content
                                            </span>
                                            {% endif %}
                                            
                                            <!-- Enhanced Badge -->
                                            {% if article.get('enhanced') %}
                                            <span class="badge bg-success badge-sm">
                                                <i class="fas fa-magic"></i> Enhanced
                                            </span>
                                            {% endif %}
                                            
                                            <!-- Relevance Score for AlphaVantage -->
                                            {% if article.source_type == 'alphavantage_premium' and article.get('relevance_score') %}
                                            <span class="badge bg-light text-dark badge-sm">
                                                Relevance: {{ article.relevance_score|round(2) }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Expandable Section for Remaining Articles -->
                        {% set remaining_articles = articles[4:] %}
                        {% if remaining_articles|length > 0 %}
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#remainingArticles" aria-expanded="false" aria-controls="remainingArticles" id="expandArticlesBtn">
                                <i class="fas fa-chevron-down me-2"></i>
                                Show Remaining {{ remaining_articles|length }} Articles
                                <small class="text-muted ms-2">({{ remaining_articles|length }} additional sources)</small>
                            </button>
                        </div>
                        
                        <div class="collapse mt-3" id="remainingArticles">
                            <hr class="my-3">
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted mb-3">
                                        <i class="fas fa-list me-2"></i>Additional Sources (Articles 5-{{ metrics.total_articles }})
                                        <small class="text-muted">- Comprehensive coverage from all premium sources</small>
                                    </h6>
                                </div>
                            </div>
                            
                            <!-- Grid Layout for Remaining Articles -->
                            <div class="row">
                                {% for article in remaining_articles %}
                                <div class="col-md-6 mb-3">
                                    <div class="additional-article p-3 border rounded">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="badge bg-light text-dark badge-sm me-2">#{{ loop.index + 4 }}</span>
                                            
                                            <!-- Compact Source Indicators -->
                                            {% if article.source_type == 'alphavantage_premium' %}
                                            <span class="badge bg-purple badge-sm">
                                                <i class="fas fa-brain"></i> AV+Sentiment
                                            </span>
                                            {% elif article.source_type == 'nyt_api' %}
                                            <span class="badge bg-warning badge-sm">
                                                <i class="fas fa-newspaper"></i> NYT
                                            </span>
                                            {% elif article.source_type == 'rss_feed' %}
                                            <span class="badge bg-info badge-sm">
                                                <i class="fas fa-rss"></i> RSS
                                            </span>
                                            {% elif article.source in ['bloomberg.com', 'reuters.com', 'wsj.com', 'ft.com'] %}
                                            <span class="badge bg-success badge-sm">
                                                <i class="fas fa-crown"></i> Premium
                                            </span>
                                            {% endif %}
                                        </div>
                                        
                                        <h6 class="mb-2" style="font-size: 0.9rem; line-height: 1.3;">
                                            <a href="{{ article.link or article.url or article.web_url or '#' }}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                                                {{ article.title|truncate(80) }}
                                                <i class="fas fa-external-link-alt ms-1" style="font-size: 0.6rem;"></i>
                                            </a>
                                        </h6>
                                        
                                        <p class="mb-2 text-muted" style="font-size: 0.8rem;">
                                            {{ article.snippet|truncate(120) }}
                                        </p>
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-globe me-1"></i>{{ article.source }}
                                            </small>
                                            
                                            {% if article.source_type == 'alphavantage_premium' and article.get('sentiment_label') %}
                                            <span class="badge 
                                                {% if article.sentiment_label == 'Bullish' %}bg-success
                                                {% elif article.sentiment_label == 'Bearish' %}bg-danger
                                                {% else %}bg-secondary{% endif %} badge-sm">
                                                {{ article.sentiment_label }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Article Statistics -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-chart-bar me-2"></i>Complete Article Breakdown (All {{ metrics.total_articles }})</h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <strong>AlphaVantage:</strong> {{ metrics.alphavantage_articles }} articles<br>
                                                <small class="text-muted">Full content + sentiment analysis</small>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>NYT API:</strong> {{ metrics.nyt_articles }} articles<br>
                                                <small class="text-muted">Full abstracts + editorial quality</small>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Premium RSS:</strong> {{ metrics.rss_articles }} articles<br>
                                                <small class="text-muted">Bloomberg, Reuters, WSJ feeds</small>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>Premium Sources:</strong> {{ metrics.high_quality_sources }} articles<br>
                                                <small class="text-muted">{{ metrics.premium_coverage }}% coverage</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <style>
                /* Additional CSS for enhanced article display */
                .priority-article {
                    border-left: 3px solid #007bff;
                    background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
                    padding: 1rem;
                    margin-bottom: 1rem;
                    border-radius: 8px;
                }

                .priority-link {
                    font-weight: 600;
                    color: #0d47a1 !important;
                }

                .additional-article {
                    transition: transform 0.2s, box-shadow 0.2s;
                    height: 100%;
                }

                .additional-article:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                }

                .bg-purple { 
                    background-color: #6f42c1 !important; 
                }

                .alphavantage-source { 
                    color: #6f42c1; 
                    font-weight: 600; 
                }

                .nyt-source { 
                    color: #fd7e14; 
                    font-weight: 600; 
                }

                .rss-source { 
                    color: #20c997; 
                    font-weight: 600; 
                }

                .premium-source { 
                    color: #28a745; 
                    font-weight: 600; 
                }

                .standard-source { 
                    color: #6c757d; 
                }

                /* Collapse button animation */
                #expandArticlesBtn[aria-expanded="true"] .fa-chevron-down {
                    transform: rotate(180deg);
                    transition: transform 0.3s ease;
                }

                #expandArticlesBtn[aria-expanded="false"] .fa-chevron-down {
                    transform: rotate(0deg);
                    transition: transform 0.3s ease;
                }
                </style>

                <!-- Chatbot Card - Insert after Source Articles section -->
                {% if run_id and sources_map_json %}
                <div class="card mt-4" id="chatbotCard">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-comments"></i> AI Research Assistant
                            <small class="ms-2">Ask questions about {{ company }}</small>
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Chat Input -->
                        <div class="mb-3">
                            <label for="chatInput" class="form-label small text-muted">Ask about earnings, forecasts, risks, or any financial topic:</label>
                            <textarea 
                                class="form-control" 
                                id="chatInput" 
                                rows="3" 
                                placeholder="e.g., What are the key risks for {{ company }} this quarter?"
                                aria-label="Chat input for AI assistant"
                            ></textarea>
                        </div>
                        
                        <!-- Controls -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex gap-2 flex-wrap">
                                <button 
                                    type="button" 
                                    class="btn btn-primary btn-sm" 
                                    id="chatAskBtn"
                                    aria-label="Send question to AI assistant"
                                >
                                    <i class="fas fa-paper-plane"></i> Ask
                                </button>
                                
                                <button 
                                    type="button" 
                                    class="btn btn-outline-secondary btn-sm" 
                                    id="btnExpandAnswer"
                                    aria-label="Toggle detailed analysis mode"
                                >
                                    <i class="fas fa-expand-arrows-alt"></i> More Detail
                                </button>
                                
                                {% if quality_validation and quality_validation.enabled %}
                                <button 
                                    type="button" 
                                    class="btn btn-outline-info btn-sm" 
                                    id="btnVerify"
                                    aria-label="Verify answer with live web search"
                                >
                                    <i class="fas fa-globe"></i> Verify with Web
                                </button>
                                {% endif %}
                            </div>
                            
                            <small class="text-muted">
                                <kbd>Enter</kbd> to send, <kbd>Shift+Enter</kbd> for new line
                            </small>
                        </div>
                        
                        <!-- Answer Display -->
                        <div id="chatAnswer" aria-live="polite" class="mb-3" style="min-height: 40px;">
                            <div class="text-muted text-center py-3">
                                <i class="fas fa-robot"></i> Ask a question to get AI-powered insights about {{ company }}
                            </div>
                        </div>
                        
                        <!-- Citations -->
                        <div id="chatCitations" class="mt-2"></div>
                    </div>
                </div>
                {% endif %}

                <script>
                // Update button text when expanded/collapsed - FIXED VERSION
                document.getElementById('expandArticlesBtn').addEventListener('click', function() {
                    const remainingCount = {{ remaining_articles|length }};
                    const totalCount = {{ metrics.total_articles }};
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    
                    if (isExpanded) {
                        // Will be collapsed after click
                        setTimeout(() => {
                            this.innerHTML = `<i class="fas fa-chevron-down me-2"></i>Show Remaining ${remainingCount} Articles <small class="text-muted ms-2">(${remainingCount} additional sources)</small>`;
                        }, 300);
                    } else {
                        // Will be expanded after click
                        setTimeout(() => {
                            this.innerHTML = `<i class="fas fa-chevron-up me-2"></i>Hide Additional Articles <small class="text-muted ms-2">(showing all ${totalCount})</small>`;
                        }, 300);
                    }
                });
                </script>
                {% endif %}

                <!-- Enhanced Analysis Methodology -->
                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle"></i> Enhanced Analysis Methodology</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <ul class="mb-0 small">
                                <li><strong>Data Sources:</strong> 
                                    {% if metrics.alphavantage_articles > 0 %}AlphaVantage API ({{ metrics.alphavantage_articles }} with sentiment), {% endif %}
                                    {% if metrics.nyt_articles is defined and metrics.nyt_articles > 0 %}NYT API ({{ metrics.nyt_articles }} abstracts), {% endif %}
                                    {% if metrics.rss_articles is defined and metrics.rss_articles > 0 %}Premium RSS ({{ metrics.rss_articles }} feeds), {% endif %}
                                    Google Search fallback
                                </li>
                                <li><strong>Content Quality:</strong> {{ metrics.alphavantage_coverage|default(0)|round }}% full content, {{ metrics.premium_coverage|default(0)|round }}% premium sources</li>
                                <li><strong>Analysis Features:</strong> 
                                    {% if metrics.alphavantage_articles > 0 %}Sentiment analysis, relevance scoring, {% endif %}
                                    quantified financial impacts, trading context
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul class="mb-0 small">
                                <li><strong>Processing:</strong> {{ articles_analyzed|default(metrics.total_articles) }} articles analyzed, {{ articles_displayed|default(8) }} top articles displayed</li>
                                
                                <!-- Enhanced Quality Information -->
                                {% if quality_validation and quality_validation.enabled %}
                                <li><strong>Quality Validation:</strong> 
                                    {% if quality_validation.score %}
                                    {{ quality_validation.score|round(1) }}/10 
                                    ({{ quality_validation.quality_grade or 'Graded' }})
                                    {% else %}
                                    Enabled
                                    {% endif %}
                                    - Fact verification, valuation context, investment actionability
                                </li>
                                {% endif %}
                                
                                <li><strong>Analysis Grade:</strong> {{ metrics.analysis_quality }} - 
                                    {% if analysis_quality == 'Premium+' %}Multi-source with sentiment analysis
                                    {% elif analysis_quality == 'Institutional' %}Premium sources with quantified impacts
                                    {% elif analysis_quality == 'Professional' %}Enhanced analysis with business context
                                    {% else %}Comprehensive analysis of available data{% endif %}
                                </li>
                                <li><strong>Source Diversity:</strong> {{ (source_performance.values() | list | length) if source_performance else "Multiple" }} premium data sources integrated</li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr class="my-3">
                    <div class="row">
                        <div class="col-12">
                            <small class="text-muted">
                                {% if quality_validation and quality_validation.enabled %}
                                <strong>Quality Assurance:</strong> All analyses undergo institutional-grade validation including fact verification, valuation context assessment, and investment actionability review. 
                                {% endif %}
                                <strong>Limitations:</strong> Premium paywalled content limited to excerpts unless available via APIs. 
                                <strong>Disclaimer:</strong> For informational purposes only. Not investment advice. 
                                Consult latest SEC filings and qualified financial advisors.
                                <strong>Data Freshness:</strong> Analysis generated on {{ analysis_timestamp or "recent request" }}.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Action Buttons -->
                <div class="text-center mt-4 mb-5">
                    <a href="/news" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Analyze Another Company
                    </a>
                    <button onclick="window.print()" class="btn btn-outline-secondary">
                        <i class="fas fa-print"></i> Print Analysis
                    </button>
                    <button onclick="exportAnalysis()" class="btn btn-outline-info">
                        <i class="fas fa-download"></i> Export Summary
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script>
        function exportAnalysis() {
            const company = {{ company|tojson }};
            const dateRange = "{{ date_range }}";
            const analysisQuality = "{{ metrics.analysis_quality }}";
            const sourceBreakdown = {
                total: {{ metrics.total_articles }},
                alphavantage: {{ metrics.alphavantage_articles|default(0) }},
                nyt: {{ metrics.nyt_articles|default(0) }},
                rss: {{ metrics.rss_articles|default(0) }},
                premium: {{ metrics.high_quality_sources|default(0) }}
            };
            
            let text = `PREMIUM FINANCIAL ANALYSIS: ${company}\n`;
            text += `Analysis Quality: ${analysisQuality}\n`;
            text += `Date Range: ${dateRange}\n`;
            text += `Generated: ${new Date().toLocaleString()}\n\n`;
            
            text += `SOURCE BREAKDOWN:\n`;
            text += `• Total Articles: ${sourceBreakdown.total}\n`;
            if (sourceBreakdown.alphavantage > 0) text += `• AlphaVantage (Full Content + Sentiment): ${sourceBreakdown.alphavantage}\n`;
            if (sourceBreakdown.nyt > 0) text += `• NYT API (Full Abstracts): ${sourceBreakdown.nyt}\n`;
            if (sourceBreakdown.rss > 0) text += `• Premium RSS Feeds: ${sourceBreakdown.rss}\n`;
            text += `• Premium Sources Total: ${sourceBreakdown.premium}\n\n`;
            
            // Add summaries
            text += "EXECUTIVE SUMMARY:\n";
            {% for bullet in summaries.executive %}
            text += "• {{ bullet|striptags }}\n";
            {% endfor %}
            
            text += "\nINVESTOR INSIGHTS:\n";
            {% for bullet in summaries.investor %}
            text += "• {{ bullet|striptags }}\n";
            {% endfor %}
            
            text += "\nCATALYSTS & RISKS:\n";
            {% for bullet in summaries.catalysts %}
            text += "• {{ bullet|striptags }}\n";
            {% endfor %}
            
            text += "\n" + "=".repeat(50) + "\n";
            text += "Analysis powered by premium financial data sources\n";
            text += "Generated by institutional-grade news analysis system\n";
            
            // Create download
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${company.replace(/\s+/g, '_')}_premium_analysis_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // Print styles
        window.addEventListener('beforeprint', function() {
            const backButton = document.querySelector('.back-button');
            const analysisBreakdown = document.querySelector('.analysis-breakdown');
            
            if (backButton) {
                backButton.style.display = 'none';
            }
            
            if (analysisBreakdown) {
                analysisBreakdown.style.background = '#f8f9fa';
                analysisBreakdown.style.color = '#000';
            }
        });

        window.addEventListener('afterprint', function() {
            const backButton = document.querySelector('.back-button');
            const analysisBreakdown = document.querySelector('.analysis-breakdown');
            
            if (backButton) {
                backButton.style.display = 'block';
            }
            
            if (analysisBreakdown) {
                analysisBreakdown.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                analysisBreakdown.style.color = 'white';
            }
        });
        
        // Add purple color for AlphaVantage branding
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                .bg-purple { background-color: #6f42c1 !important; }
                .text-purple { color: #6f42c1 !important; }
                .badge.bg-purple { background-color: #6f42c1 !important; }
            `;
            document.head.appendChild(style);

            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>

    <script>
    // Chatbot functionality - Compact AI Research Assistant
    (function() {
        // Initialize source mapping from Jinja template with safe defaults
        const SOURCE_MAP = {{ sources_map_json|default({})|tojson }};

        // Validate SOURCE_MAP structure
        if (SOURCE_MAP && typeof SOURCE_MAP === 'object') {
            // Convert any malformed entries
            Object.keys(SOURCE_MAP).forEach(key => {
                if (!SOURCE_MAP[key] || typeof SOURCE_MAP[key] !== 'object') {
                    console.warn(`Malformed source map entry for key ${key}:`, SOURCE_MAP[key]);
                    SOURCE_MAP[key] = { url: '#', title: `Source ${key}`, source: 'Unknown' };
                }
            });
        }

        const COMPANY = {{ company|tojson }};
        const WINDOW_DAYS = {{ window_days|default(30) }};
        const RUN_ID = {{ run_id|default("")|tojson }};
        
        // State management
        // State management
        let isExpanded = false;
        let currentAbortController = null;
        let conversationHistory = [];
        
        // DOM elements (with safe guards)
        const chatInput = document.getElementById('chatInput');
        const chatAskBtn = document.getElementById('chatAskBtn');
        const btnExpandAnswer = document.getElementById('btnExpandAnswer');
        const btnVerify = document.getElementById('btnVerify'); // May not exist
        const chatAnswer = document.getElementById('chatAnswer');
        const chatCitations = document.getElementById('chatCitations');
        
        if (!chatInput || !chatAskBtn || !chatAnswer || !chatCitations) {
            console.warn('Chatbot elements not found, skipping initialization');
            return;
        }
        
        // Check if chatbot is properly configured
        if (!RUN_ID) {
            console.warn('Chatbot not available: missing run_id');
            // Disable chatbot UI
            if (chatInput) chatInput.disabled = true;
            if (chatAskBtn) chatAskBtn.disabled = true;
            if (chatAnswer) {
                chatAnswer.innerHTML = `
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-info-circle"></i> Chatbot temporarily unavailable. Please refresh the page.
                    </div>
                `;
            }
            return;
        }
        
        // Event handlers
        chatAskBtn.addEventListener('click', () => askChat(false));
        
        if (btnExpandAnswer) {
            btnExpandAnswer.addEventListener('click', function() {
                isExpanded = !isExpanded;
                this.classList.toggle('btn-outline-secondary', !isExpanded);
                this.classList.toggle('btn-secondary', isExpanded);
                
                const icon = this.querySelector('i');
                if (icon) {
                    icon.className = isExpanded ? 'fas fa-compress-arrows-alt' : 'fas fa-expand-arrows-alt';
                }
            });
        }
        
        if (btnVerify) {
            btnVerify.addEventListener('click', () => askChat(true));
        }
        
        // Keyboard handling: Enter submits, Shift+Enter adds newline
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                askChat(false);
            }
        });
        
        /**
         * Convert markdown to HTML and linkify [S#] references
         */
        function processMarkdownAndLinks(text, sourceMap) {
            if (!text || typeof text !== 'string') return '';
            
            // Step 1: Escape HTML to prevent XSS
            const escapeDiv = document.createElement('div');
            escapeDiv.textContent = text;
            let processedText = escapeDiv.innerHTML;
            
            // Step 2: Convert markdown formatting to HTML
            // Bold: **text** -> <strong>text</strong>
            processedText = processedText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Italic: *text* -> <em>text</em>
            processedText = processedText.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Lists: - item -> • item (bullet points)
            processedText = processedText.replace(/^- (.+)$/gm, '• $1');
            
            // Line breaks: preserve paragraph breaks
            processedText = processedText.replace(/\n\n/g, '</p><p>');
            processedText = processedText.replace(/\n/g, '<br>');
            
            // Wrap in paragraph tags if not already
            if (!processedText.startsWith('<p>')) {
                processedText = '<p>' + processedText + '</p>';
            }
            
            // Step 3: Replace [S#], [S3,S9], [S3–S5], [Sources: 3, 7-8] with source links
            const rx = /\[(?:Sources?:)?\s*([0-9,\s\-–]+)\]|\[?S\s*(\d+)\]?/gi;

            function expandList(list) {
            const parts = list.split(/[,\s]+/).filter(Boolean);
            const nums = [];
            for (const p of parts) {
                const m = p.match(/^(\d+)[\-–](\d+)$/);
                if (m) {
                let a = parseInt(m[1],10), b = parseInt(m[2],10);
                if (a <= b) for (let i=a;i<=b;i++) nums.push(i);
                } else if (/^\d+$/.test(p)) {
                nums.push(parseInt(p,10));
                }
            }
            return [...new Set(nums)];
            }

            function makeBadge(n) {
            const s = sourceMap[String(n)];
            if (!s || !s.url) return '';
            const title = (s.title || `Source S${n}`).replace(/"/g, '&quot;');
            return `<a href="${escapeHtml(s.url)}" target="_blank" rel="noopener"
                        class="badge bg-primary text-decoration-none source-badge"
                        title="${title}">
                        <i class="fas fa-link"></i> S${n}
                    </a>`;
            }

            processedText = processedText.replace(rx, function (_m, groupList, single) {
            if (groupList) {
                const badges = expandList(groupList).map(makeBadge).filter(Boolean).join(' ');
                return badges ? (' ' + badges) : '';
            }
            if (single) return makeBadge(parseInt(single,10)) || _m;
            return _m;
            });
            
            return processedText;
        }
        
        /**
         * HTML escape helper
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * Main chat function with conversation history and comprehensive error handling
         */
        async function askChat(verify = false) {
            const question = chatInput.value.trim();
            
            if (!question) {
                showError('Please enter a question first.');
                chatInput.focus();
                return;
            }
            
            if (!RUN_ID) {
                showError('Chatbot session unavailable. Please refresh the page and try again.');
                return;
            }
            
            // Add user question to conversation history
            conversationHistory.push({
                role: 'user',
                content: question,
                timestamp: new Date().toISOString()
            });
            
            // Abort any existing request
            if (currentAbortController) {
                currentAbortController.abort();
            }
            
            // Create new AbortController with 60s timeout (increased for web search)
            currentAbortController = new AbortController();
            const timeoutId = setTimeout(() => {
                currentAbortController.abort();
            }, 60000);
            
            // Update UI to loading state
            setLoadingState(true);
            clearPreviousAnswer();
            
            try {
                // Prepare request data with conversation history
                const requestData = {
                    company: COMPANY,
                    question: isExpanded ? question + " (More detail please)" : question,
                    conversation_history: conversationHistory, // ✅ ADD THIS LINE
                    window_days: WINDOW_DAYS,
                    verify_with_web: verify,
                    run_id: RUN_ID
                };
                
                // Make API call
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    signal: currentAbortController.signal
                });
                
                clearTimeout(timeoutId);
                
                // Handle non-200 responses
                if (!response.ok) {
                    let errorMessage = `Request failed (${response.status})`;
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        errorMessage = response.statusText || errorMessage;
                    }
                    
                    throw new Error(errorMessage);
                }
                
                // Parse response
                const data = await response.json();
                
                if (!data.answer) {
                    throw new Error('No answer received from server');
                }
                
                // Add assistant response to conversation history
                conversationHistory.push({
                    role: 'assistant', 
                    content: data.answer,
                    timestamp: new Date().toISOString(),
                    citations: data.citations || []
                });
                
                // Display results
                displayAnswer(data.answer, data.citations || []);
                
                // Clear input for next question
                chatInput.value = '';
                
            } catch (error) {
                clearTimeout(timeoutId);
                
                // Remove the failed user message from history
                if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'user') {
                    conversationHistory.pop();
                }
                
                if (error.name === 'AbortError') {
                    showError('Request timed out. Please try again with a shorter question.');
                } else if (error.message.includes('Failed to fetch')) {
                    showError('Network error. Please check your connection and try again.');
                } else {
                    showError(`Error: ${error.message}`);
                }
                
            } finally {
                setLoadingState(false);
                currentAbortController = null;
            }
        }
        /**
         * Display the AI answer with formatted markdown and source links
         */
        function displayAnswer(answerText, citations) {
            // Process answer text with markdown formatting and source links
            const processedAnswer = processMarkdownAndLinks(answerText, SOURCE_MAP);
            
            chatAnswer.innerHTML = `
                <div class="alert alert-light border">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-robot text-info me-2 mt-1"></i>
                        <div class="flex-grow-1 formatted-response">
                            ${processedAnswer}
                        </div>
                    </div>
                </div>
            `;
            
            // Display citations if provided
            displayCitations(citations);
        }
        
        /**
         * Display citation chips
         */
        function displayCitations(citations) {
            if (!citations || citations.length === 0) {
                // Try to extract citations from parsed [S#] tokens in SOURCE_MAP
                const extractedCitations = extractCitationsFromSourceMap();
                if (extractedCitations.length > 0) {
                    citations = extractedCitations;
                }
            }
            
            if (citations && citations.length > 0) {
                const citationHtml = citations.map(citation => {
                    const sourceNum = citation.s || citation.source_number || 'Unknown';
                    const title = citation.title || 'Source';
                    const url = citation.url || '#';
                    
                    return `
                        <a href="${escapeHtml(url)}" target="_blank" rel="noopener" 
                        class="badge bg-secondary text-decoration-none me-1 mb-1" 
                        title="${escapeHtml(title)}">
                            [S${sourceNum}] ${title.length > 25 ? title.substring(0, 25) + '...' : title}
                        </a>
                    `;
                }).join('');
                
                chatCitations.innerHTML = `
                    <div class="mt-2">
                        <small class="text-muted d-block mb-1">Sources:</small>
                        ${citationHtml}
                    </div>
                `;
            } else {
                chatCitations.innerHTML = '';
            }
        }
        
        /**
         * Extract citations from SOURCE_MAP for fallback
         */
        function extractCitationsFromSourceMap() {
            const citations = [];
            Object.keys(SOURCE_MAP).forEach(key => {
                const sourceData = SOURCE_MAP[key];
                if (sourceData) {
                    citations.push({
                        s: parseInt(key),
                        title: sourceData.title || 'Source',
                        url: sourceData.url || '#'
                    });
                }
            });
            return citations.slice(0, 5); // Limit to 5 sources
        }
        
        /**
         * Show error message
         */
        function showError(message) {
            chatAnswer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${escapeHtml(message)}
                </div>
            `;
            chatCitations.innerHTML = '';
        }
        
       /**
         * Set loading state with progress indication
         */
        function setLoadingState(isLoading) {
            chatAskBtn.disabled = isLoading;
            chatInput.disabled = isLoading;
            
            if (btnExpandAnswer) btnExpandAnswer.disabled = isLoading;
            if (btnVerify) btnVerify.disabled = isLoading;
            
            if (isLoading) {
                chatAskBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
                
                // Enhanced loading with progress indication
                let loadingStep = 0;
                const loadingSteps = [
                    "Analyzing your question...",
                    "Searching the web for latest data...", 
                    "Processing search results...",
                    "Generating comprehensive answer..."
                ];
                
                chatAnswer.innerHTML = `
                    <div class="text-center py-3 text-muted">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="loadingText">${loadingSteps[0]}</span>
                    </div>
                `;
                
                // Update loading text every 10 seconds
                const loadingInterval = setInterval(() => {
                    loadingStep = (loadingStep + 1) % loadingSteps.length;
                    const loadingText = document.getElementById('loadingText');
                    if (loadingText) {
                        loadingText.textContent = loadingSteps[loadingStep];
                    }
                }, 10000);
                
                // Store interval to clear later
                chatAskBtn.dataset.loadingInterval = loadingInterval;
                
            } else {
                chatAskBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Ask';
                
                // Clear loading interval
                if (chatAskBtn.dataset.loadingInterval) {
                    clearInterval(chatAskBtn.dataset.loadingInterval);
                    delete chatAskBtn.dataset.loadingInterval;
                }
            }
        }
        
        /**
         * Clear previous answer
         */
        function clearPreviousAnswer() {
            chatCitations.innerHTML = '';
        }
        
        // Acceptance tests as comments:
        // ✓ Enter key submits (handled by keydown event)
        // ✓ Shift+Enter adds newline (default browser behavior when prevented)
        // ✓ [S12] tokens become clickable badges (linkifySRefs function)
        // ✓ Network errors show red error text (showError function)
        // ✓ btnVerify guarded (checked for existence)
        // ✓ No HTML from answer executed (escaped with textContent)
        
    })();
    </script>

    <script>
    (function () {
    // Pull the same map you already pass to the chatbot (safe even if undefined)
    const SOURCE_MAP = {{ sources_map_json|default({})|tojson }};

    // Validate SOURCE_MAP structure
    if (SOURCE_MAP && typeof SOURCE_MAP === 'object') {
        // Convert any malformed entries
        Object.keys(SOURCE_MAP).forEach(key => {
            if (!SOURCE_MAP[key] || typeof SOURCE_MAP[key] !== 'object') {
                console.warn(`Malformed source map entry for key ${key}:`, SOURCE_MAP[key]);
                SOURCE_MAP[key] = { url: '#', title: `Source ${key}`, source: 'Unknown' };
            }
        });
    }

    if (!SOURCE_MAP || Object.keys(SOURCE_MAP).length === 0) return;

    // Matches [S7], [S3,S9], [S3–S5], [Sources: 3, 7-8], S12, etc.
    const RX = /\[(?:Sources?:)?\s*([0-9,\s\-–]+)\]|\[?S\s*(\d+)\]?/gi;

    function expandList(list) {
        const parts = list.split(/[,\s]+/).filter(Boolean);
        const out = [];
        for (const p of parts) {
        const m = p.match(/^(\d+)[\-–](\d+)$/);
        if (m) {
            let a = parseInt(m[1],10), b = parseInt(m[2],10);
            if (a <= b) { for (let i=a;i<=b;i++) out.push(i); }
        } else if (/^\d+$/.test(p)) {
            out.push(parseInt(p,10));
        }
        }
        return [...new Set(out)];
    }

    function makeBadge(n) {
        const s = SOURCE_MAP[String(n)];
        if (!s || !s.url) return '';
        const title = (s.title || `Source S${n}`).replace(/"/g,'&quot;');
        const domain = (s.domain || '').replace(/</g,'&lt;');
        return `<a href="${s.url}" target="_blank" rel="noopener noreferrer"
                class="badge bg-secondary source-badge"
                data-source-num="${n}" aria-label="Source ${n}: ${domain}"
                title="${title}">
                <i class="fas fa-link"></i> S${n}
                </a>`;
    }

    function linkify(el) {
        const original = el.innerHTML;
        const replaced = original.replace(RX, function (_match, groupList, single) {
        if (groupList) {
            const badges = expandList(groupList).map(makeBadge).filter(Boolean).join(' ');
            return badges ? (' ' + badges) : '';
        }
        if (single) return makeBadge(parseInt(single,10)) || _match;
        return _match;
        });
        if (replaced !== original) el.innerHTML = replaced;
    }

    // Convert all bullets in Executive / Investor / Catalysts
    document.querySelectorAll('.insight-bullet').forEach(linkify);
    })();
    </script>
    <script>
    // Make SOURCE_MAP & optional remap available in this scope
    window.SOURCE_MAP = {{ sources_map_json|default({})|tojson }};
    window.INDEX_REMAP = {{ citations_index_map|default({})|tojson }};

    // Turn <cite index="10-1,58-1"> into clickable [S10] [S58] badges
    (function linkifyCiteTags() {
        const sourceMap = window.SOURCE_MAP || {};
        const idRemap  = window.INDEX_REMAP || {}; // maps "global" -> "local" IDs if provided

        // In bullets and chatbot answers
        const nodes = document.querySelectorAll('.insight-bullet cite[index], .formatted-response cite[index]');
        nodes.forEach(cite => {
        const indexAttr = (cite.getAttribute('index') || '').trim();
        if (!indexAttr) return;

        // Example: "10-1,58-1" → take the doc ids [10, 58]
        const rawParts   = indexAttr.split(',').map(s => s.trim()).filter(Boolean);
        const docIdsRaw  = rawParts.map(p => parseInt((p.split('-')[0] || '').trim(), 10)).filter(n => Number.isFinite(n));
        const docIds     = Array.from(new Set(docIdsRaw)); // unique, in order

        if (docIds.length === 0) return;

        // Replace the <cite> element with its text, and append badges after it
        const textSpan = document.createElement('span');
        textSpan.innerHTML = cite.innerHTML;
        cite.replaceWith(textSpan);

        const chips = document.createElement('span');
        chips.className = 'ms-1';

        let matched = 0;
        docIds.forEach(globalId => {
            const localId = idRemap[String(globalId)] ?? globalId; // remap if possible
            const src     = sourceMap[String(localId)];
            if (!src || !src.url) {
            // Helpful diagnostics
            console.warn('No source mapping for citation id:', { globalId, localId });
            return;
            }
            matched++;

            const a = document.createElement('a');
            a.href        = src.url;
            a.target      = '_blank';
            a.rel         = 'noopener';
            a.className   = 'badge bg-primary text-decoration-none source-badge me-1';
            a.title       = (src.title || 'Source') + (src.published_at ? ` • ${src.published_at}` : '');
            a.textContent = `S${localId}`;
            chips.appendChild(a);
        });

        if (matched) textSpan.insertAdjacentElement('afterend', chips);
        });
    })();
    </script>
{% endblock %}