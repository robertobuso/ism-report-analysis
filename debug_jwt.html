<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Debug Tool</title>
    <style>
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; margin-top: 30px; }
        .section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #3e3e3e;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #1177bb; }
        pre {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border: 1px solid #3e3e3e;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            background: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #3e3e3e;
            border-radius: 4px;
            font-family: 'Monaco', 'Courier New', monospace;
            margin: 10px 0;
        }
        textarea { min-height: 100px; }
        .step {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #569cd6;
        }
        .result {
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>üî¨ JWT Debug Tool - Find the REAL Problem</h1>

    <div class="section">
        <h2>Step 1: Get JWT from Browser</h2>
        <div class="step">
            <p>1. Go to: <a href="https://envoyllc-ism.up.railway.app" target="_blank">https://envoyllc-ism.up.railway.app</a></p>
            <p>2. Log in with Google</p>
            <p>3. Open DevTools Console (F12 ‚Üí Console)</p>
            <p>4. Type: <code>localStorage.getItem('token')</code></p>
            <p>5. Copy the token value</p>
        </div>
        <button onclick="getTokenFromLocalStorage()">Auto-Get Token (if on PI site)</button>
        <textarea id="token" placeholder="Or paste JWT token here..."></textarea>
        <div id="tokenInfo"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test /api/v1/auth/me Endpoint</h2>
        <button onclick="testAuthMe()">Test Auth Endpoint</button>
        <div id="authResult"></div>
    </div>

    <div class="section">
        <h2>Step 3: Test Debug Endpoint</h2>
        <button onclick="testDebugEndpoint()">Test Debug Endpoint</button>
        <div id="debugResult"></div>
    </div>

    <div class="section">
        <h2>Step 4: Decode JWT Locally</h2>
        <button onclick="decodeJWT()">Decode JWT (No Verification)</button>
        <div id="decodeResult"></div>
    </div>

    <script>
        const API_BASE = 'https://portfolio-intelligence-api-production.up.railway.app';

        function getTokenFromLocalStorage() {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('token').value = token;
                document.getElementById('tokenInfo').innerHTML = `<p class="success">‚úÖ Token found in localStorage (length: ${token.length})</p>`;
                decodeJWT();
            } else {
                document.getElementById('tokenInfo').innerHTML = `<p class="error">‚ùå No token in localStorage. Make sure you're on the Portfolio Intelligence site.</p>`;
            }
        }

        async function testAuthMe() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                document.getElementById('authResult').innerHTML = `<p class="error">‚ùå Please enter a token first</p>`;
                return;
            }

            document.getElementById('authResult').innerHTML = `<p class="warning">‚è≥ Testing /api/v1/auth/me...</p>`;

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('authResult').innerHTML = `
                        <p class="success">‚úÖ SUCCESS! Auth endpoint returned 200</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p class="warning">‚ö†Ô∏è If this works, the problem is in the frontend redirect logic!</p>
                    `;
                } else {
                    document.getElementById('authResult').innerHTML = `
                        <p class="error">‚ùå FAILED! Status: ${response.status}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                        <p class="warning">üëÜ THIS IS THE ACTUAL ERROR FROM PRODUCTION!</p>
                    `;
                }
            } catch (error) {
                document.getElementById('authResult').innerHTML = `
                    <p class="error">‚ùå Network Error: ${error.message}</p>
                `;
            }
        }

        async function testDebugEndpoint() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                document.getElementById('debugResult').innerHTML = `<p class="error">‚ùå Please enter a token first</p>`;
                return;
            }

            document.getElementById('debugResult').innerHTML = `<p class="warning">‚è≥ Testing /api/v1/auth/debug/jwt...</p>`;

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/debug/jwt?token=${encodeURIComponent(token)}`);
                const data = await response.json();

                const statusClass = data.status?.includes('‚úÖ') ? 'success' : 'error';

                document.getElementById('debugResult').innerHTML = `
                    <p class="${statusClass}">${data.status || 'Result:'}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                document.getElementById('debugResult').innerHTML = `
                    <p class="error">‚ùå Error: ${error.message}</p>
                `;
            }
        }

        function decodeJWT() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                document.getElementById('decodeResult').innerHTML = `<p class="error">‚ùå Please enter a token first</p>`;
                return;
            }

            try {
                // JWT structure: header.payload.signature
                const parts = token.split('.');
                if (parts.length !== 3) {
                    throw new Error('Invalid JWT format (should have 3 parts)');
                }

                // Decode header and payload (base64url)
                const header = JSON.parse(atob(parts[0].replace(/-/g, '+').replace(/_/g, '/')));
                const payload = JSON.parse(atob(parts[1].replace(/-/g, '+').replace(/_/g, '/')));

                // Check expiration
                const now = Math.floor(Date.now() / 1000);
                const exp = payload.exp;
                const expired = exp && exp < now;
                const timeUntilExpiry = exp ? exp - now : null;

                let expiryInfo = '';
                if (expired) {
                    expiryInfo = `<p class="error">‚ùå TOKEN IS EXPIRED! (expired ${Math.floor((now - exp) / 60)} minutes ago)</p>`;
                } else if (timeUntilExpiry) {
                    expiryInfo = `<p class="success">‚úÖ Token not expired (expires in ${Math.floor(timeUntilExpiry / 60)} minutes)</p>`;
                }

                // Check claims
                const hasEmail = 'email' in payload;
                const hasSub = 'sub' in payload;

                let claimInfo = '';
                if (hasEmail) {
                    claimInfo = `<p class="success">‚úÖ Has 'email' claim: ${payload.email} (Flask-issued)</p>`;
                } else if (hasSub) {
                    claimInfo = `<p class="success">‚úÖ Has 'sub' claim: ${payload.sub} (TradeStation-issued)</p>`;
                } else {
                    claimInfo = `<p class="error">‚ùå Missing both 'email' and 'sub' claims!</p>`;
                }

                document.getElementById('decodeResult').innerHTML = `
                    <p class="success">‚úÖ JWT Decoded (without signature verification)</p>
                    ${expiryInfo}
                    ${claimInfo}
                    <h3>Header:</h3>
                    <pre>${JSON.stringify(header, null, 2)}</pre>
                    <h3>Payload:</h3>
                    <pre>${JSON.stringify(payload, null, 2)}</pre>
                    <p class="warning">‚ö†Ô∏è Note: This doesn't verify the signature, just reads the claims</p>
                `;
            } catch (error) {
                document.getElementById('decodeResult').innerHTML = `
                    <p class="error">‚ùå Failed to decode: ${error.message}</p>
                `;
            }
        }

        // Auto-check for token on load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                getTokenFromLocalStorage();
            }
        });
    </script>
</body>
</html>
